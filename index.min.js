module.exports=function(){"use strict";var o,e,r,n=process.env.SERVERTYPE||"http",i=process.env.PORT;function t(o){return logger.info("onCreateUser: user data = "+JSON.stringify(o)),usersDB.addUser({...o,id:this.id}),{id:this.id}}function s(o,e){logger.info("joinRoom: user data = "+JSON.stringify(o)),this.join(o.room),this.room=o.room;var n=this.id,i=usersDB.getUsersByRoom(o.room),t=1,s=!1;i.length>2?(e({nr:t=0}),logger.info("onJoinRoom, the table is full, remove user with id: "+n),usersDB.removeUser(n)):2===i.length?(s=!0,e({nr:t=2})):e({nr:t=1}),this.playernr=t,logger.info("joinRoom: user "+o.name+" = player no: "+this.playernr),i=usersDB.getUsersByRoom(o.room),logger.info("joinRoom: users in "+o.room+" = "+JSON.stringify(i)),s&&(logger.info("joinRoom: the room is full, start game  "),r.to(o.room).emit("startGame",i))}function a(o,e){o.guest=!0,logger.info("onJoinRoomAsKibitz: user data = "+JSON.stringify(o)),usersDB.addUser({...o,id:this.id}),this.join(o.room),this.room=o.room;this.id;var r=usersDB.getUsersByRoom(o.room);e&&e(r),logger.info("onJoinRoomAsKibitz: users in "+o.room+" = "+JSON.stringify(r))}function g(o){logger.info("onChangeNumCards: data = "+JSON.stringify(o)),r.to(o.room).emit("changeNumCardsAndRestart",o)}function f(o){logger.info("onSwitchStack: data = "+JSON.stringify(o)),r.to(o.room).emit("switchStack",o)}function l(o){logger.info("onFlipCard: data = "+JSON.stringify(o)),logger.info("onFlipCard:  broadcast  flipCard"),r.to(o.room).emit("flipCard",o)}function m(o){logger.info("onSendDeck: deck data = "+JSON.stringify(o)),logger.info("onSendDeck:  broadcast  useDeck"),r.to(o.room).emit("useDeck",o.deck)}function d(o){logger.info("onMoveToStack: card data = "+JSON.stringify(o)),logger.info("onMoveToStack:  broadcast  moveCard"),r.to(o.room).emit("moveCard",o)}function c(o){logger.info("onMoveToOwnStack:  card data = "+JSON.stringify(o)),logger.info("onMoveToOwnStack:   broadcast  moveCardAndSwitchPlayer"),r.to(o.room).emit("moveCardAndSwitchPlayer",o)}function u(o){logger.info("onGameOver:  data = "+JSON.stringify(o)),logger.info("onGameOver:  broadcast  gameOver"),r.to(o.room).emit("gameOver",o)}function v(o){logger.info("onAutomode:  data = "+JSON.stringify(o)),this.automode=o.automode,logger.info("onAutomode:  broadcast  setAutomode"),r.to(o.room).emit("setAutomode",o)}function h(o){logger.info("onNewGame:  data = "+JSON.stringify(o));let e=usersDB.getUsersByRoom(o.room);logger.info("onNewGame:  broadcast  startNewGame"),r.to(o.room).emit("startNewGame",e)}function S(o,e){o.id&&(logger.info("onServerStatus: data: "+JSON.stringify(o)),e&&e({id:this.id,alive:!0}))}function y(o,e){if(logger.info("onPlayerSignedOut: data: "+JSON.stringify(o)),usersDB.getUser(this.id)){logger.info("  remove this player for client id = "+this.id),logger.info("  remove this player with name = "+o.nickname),logger.info("  remove this player from room = "+o.tablename);let e=usersDB.getUser(this.id);logger.info("onPlayerSignedOut user data = "+JSON.stringify(e)),usersDB.removeUser(this.id),this.leave(o.tablename),e.guest||(logger.info("onPlayerSignedOut remaining players: "+JSON.stringify(usersDB.getUsersByRoom(o.tablename))),r.to(o.tablename).emit("playerLeftGame",e))}else logger.info("  got no player for client id = "+this.id)}function O(o,e){var r="",n=0,i=[],t=usersDB.getAllUsers();logger.info("onWhosOnline players online: "+n+", all users:  "+JSON.stringify(t)),n=t.length,Object.keys(t).forEach(o=>{var e=t[o].room;-1===i.indexOf(e)&&i.push(e)}),logger.info("onWhosOnline rooms: "+JSON.stringify(i));for(var s=0,a=i.length;s<a;s++){var g=i[s];r+="Tisch: "+g+" --\x3e Spieler: ";var f=t.filter(o=>o.room===g);logger.info("onWhosOnline room: "+g+" users: "+JSON.stringify(f));for(var l=0,m=f.length;l<m;l++)r+=f[l].name,l<m-1&&(r+=", ");r+=";"}e({playersOnline:n,playerNames:r})}null!=i&&""!=i||(i=8080),logger.info("server ip address: "+JSON.stringify(ipAddress)),logger.info("configure express server for: "+n),(o=express()).use(cors()),o.options("*",cors()),console.log("process.env.NODE_ENV = "+process.env.NODE_ENV),o.use(serveStatic(__dirname+"/dist")),(e=http.createServer(o)).listen(i,()=>{logger.info("HTTP server running on port "+i)}),r=socket.listen(e,{pingInterval:1e4,pingTimeout:5e3}),logger.info("SOCKET.IO server ready for communication on port 3166"),r.on("connection",o=>{logger.info("sio new connection from socket id: "+o.id),o.on("serverstatus",S),o.on("createUser",t),o.on("joinRoom",s),o.on("joinRoomAsKibitz",a),o.on("changeNumCards",g),o.on("moveToStack",d),o.on("moveToOwnStack",c),o.on("flipCard",l),o.on("sendDeck",m),o.on("switchStack",f),o.on("gameOver",u),o.on("automode",v),o.on("newGame",h),o.on("signout",y),o.on("whosonline",O),o.on("sendmessage",function(o,e,n){var i=(new Date).format("hh:mm:ss");logger.info("sendmessage to players on: "+e+", from: "+o+" "+i+" broadcast chat: "+n+" to room "+e),r.in(e).emit("updatechat",o,i,n)});["leftGame","disconnect"].forEach(e=>{o.on(e,()=>{if(logger.info("got exit event for user "+o.id+" event = "+e),usersDB.getUser(o.id)){let e=o.id,n=usersDB.getUser(e);if(!n)return;logger.info("got exit event for user data = "+JSON.stringify(n));const{room:i,name:t}=n;usersDB.removeUser(e),o.leave(i),n.guest||(logger.info("got exit event for use, emit playerLeftGame to : "+JSON.stringify(usersDB.getUsersByRoom(i))),r.to(i).emit("playerLeftGame",n))}})})});function p(){logger.info("gracefullExit: closing http server."),setImmediate(function(){r.emit("serverdown")}),function o(e){if(logger.info(e),e>0)return setTimeout(o,1e3,e-1);theserver.close(function(){logger.info("Server closed!")})}(1)}process.on("SIGTERM",()=>{console.info("SIGTERM signal received."),p()}),process.on("SIGINT",()=>{console.info("SIGINT signal received."),p()}),process.on("SIGQUIT",()=>{console.info("SIGQUIT signal received."),p()})};